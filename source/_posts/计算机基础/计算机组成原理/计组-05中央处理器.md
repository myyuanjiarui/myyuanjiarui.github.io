---
title: 中央处理器
date: 2023-07-29 11:14 
description: 考研时任国林计算机组成原理的学习笔记
categories:
- 计算机基础
tags:
---
<head>
  <meta name="referrer" content="no-referrer" />
</head>


## CPU功能

- 指令控制：CPU从内存中获取指令并进行解码，然后执行这些指令
- 操作控制：CPU控制各种操作的顺序和方式，如算术操作、逻辑操作和数据移动操作
- 时间控制：CPU具有内部时钟，该时钟决定指令的执行速度。此功能确保各种操作同步进行
- 数据加工：CPU对输入的数据进行处理，如算术和逻辑操作
- 外部访问：CPU与外部设备和内存进行通信，以读取或写入数据
- 异常和终端处理：当CPU遇到错误或异常条件时，它有能力中断当前任务，将控制转移到特定的错误处理程序。

## CPU的组成

![image-20230909164226137](https://gitee.com/Marches7/piture-bed/raw/master/img/image-20230909164226137.png)

> 从数据角度来看，CPU可以划分为数据通路和控制器两个部分

- CPU中的寄存器

  用于暂存操作结果，状态、控制等信息。分为用户可见寄存器和系统专用寄存器。

  - 用户可见寄存器

    程序员可编程使用的寄存器。常见的有以下几类：

    - 数据寄存器
    - 地址寄存器
    - 通用寄存器：既可以存地址又可以存数据
    - 状态字寄存器PSW(标志寄存器)：存放程序运行的状态，例如ALU运算结果产生的ZF/CF/OF/SF

  - 专用寄存器(控制寄存器)

    系统专用，不可被程序员使用

    - 程序计数器(PC)：专门用于存放指令地址
    - 指令寄存器(IR)：存放当前指令
    - 存储器地址寄存器（MAR）
    - 存储器数据寄存器(MDR)
    - 控制寄存器

## CPU工作流程

<img src="https://gitee.com/Marches7/piture-bed/raw/master/img/image-20231122181058979.png" alt="image-20231122181058979" style="zoom: 67%;" />

## 微操作μOP和微操作命令μOPCmd

- 微操作

  微操作是CPU中的原子操作（不可再继续分割），微操作的组合形成不同的指令。通常可分为以下4种

  - 寄存器传送：(RS) -> RD

  - 存储器读：1->Read，M[(MAR)]->MDR

  - 存储器写：1->Write ，(MDR)->M[(MAR)]

  - 算逻运算：RS1 -> ALU，RS2 -> ALU，OP->ALU，ALU -> RD

    ~~RD<-(RS1) op (RS2)~~

- 微操作命令

  微操作命令是控制存储器中的指令，它指定要执行的微操作集合。它告诉硬件如何执行特定的微操作，包括哪些控制线应该被激活以及其他相关的硬件操作。根据不同的控制方式和数据通路结构，同一个μOP会有不同的μOPCmd

  - 寄存器传送((RS) -> RD)

    - 总线结构下

      <img src="https://gitee.com/Marches7/piture-bed/raw/master/img/image-20230909174807811.png" alt="image-20230909174807811" style="zoom: 80%;float:left" />

      RS_out，RD_in

  - 存储器读/写

    <img src="https://gitee.com/Marches7/piture-bed/raw/master/img/image-20230909213023123.png" alt="image-20230909213023123" style="zoom:67%;float:left" />

    - 异步控制方式下

      异步控制，即CPU在发出请求后需要等待存储器上个操作完成。WMFC信号用来控制CPU的等待状态。WMFC=1表示CPU处于需等待状态，WMFC=0表示CPU处于可进入状态。

      - 存储器读：Read，WMFC
      - 存储器写：Write，WMFC
  
    - 同步控制方式下
  
      同步控制，存储器始终在预定的时间内完成操作。
  
      - 存储器读：Read，MDRin
      - 存储器写：Write
  
  - 算逻运算
  
    - 单总线结构下
  
      <img src="https://gitee.com/Marches7/piture-bed/raw/master/img/image-20230909214152208.png" alt="image-20230909214152208" style="zoom:80%;float:left" />

      分三步：

      1. Ra_out，Y_in
      2. Rb_out，op，Z_in
      3. Z_out，Rc_in

μOP和μOPCmd的对应

|            | μOP                           | μOPCmd           |
| ---------- | ----------------------------- | ---------------- |
| 寄存器传送 | RS->RD                        | RS_out，RD_in    |
| MEM读      | ①1->Read                      | Read             |
|            | ②M[(MAR)]->MDR                | **WMFC**         |
| MEM写      | ①1->Write                     | Write            |
|            | ②MDR->M[(MAR)]                | **WMFC**         |
| 算逻运算   | ①Ra->Y                        | Ra_out，Y_in     |
|            | ②**Rb->ALU，op->ALU，ALU->Z** | Rb_out，op，Z_in |
|            | ③Z->Rc                        | Z_out，Rc_in     |
| 其他操作   | PC+1->PC                      | PC_+1            |
|            | 1->End                        | End              |

> **注意不存在ALUin和ALUout的uOPCmd**

## 指令执行过程

- 取指令

  CPU从PC中取出指令地址，根据地址获得指令，再将指令放到指令寄存器中，最后PC+1

  用微操作序列表示(所有指令都通用)：

  t1：(PC)->MAR，1->Read，

  t2：M[(MAR)]->MDR，(PC)+1->PC

  t3：(MDR)->IR（**取指阶段没有1->End**）

- 分析指令

  ID根据IR的内容分析指令，包括解码操作码，提取地址参数等操作

- 执行指令

  实现指令功能

> ex.按照指令执行的三大过程分析不同指令的微操作序列
>
> - 取数指令LD：M[(RS)]->RD
>
>   t1~t3：取指令序列(略)
>
>   t4：(RS)->MAR，1->Read
>
>   t5：M[(MAR)]->MDR
>
>   t6：MDR->RD，1->End
>
> - 存数指令ST：RD->M[(RS)]
>
>   t1~t3：取指令序列(略)
>
>   t4：(RS)->MAR，1->Write
>
>   t5：RD->MDR，MDR->M[(MAR)]，1->End
>
> - 减法指令SUB：(RD)-(RS)->RD
>
>   t1~t3：取指令序列(略)
>
>   t4：RS->Y，
>
>   t5：RD->ALU，SUB->ALU，ALU->Z
>
>   t6：Z->RD，1->End
>
> - 单字长，直接寻址的分支指令JNZ
>
>   t1~t3：取指令序列(略)
>
>   - ZF=0，即结果不为0时，跳转
>
>     t4：SE(DISP)->Y
>
>     t5：PC->ALU，ADD->ALU，ALU->Z
>
>     t6：Z->PC，1->End
>
>     > SE是位扩展部件
>  
>   - ZF=1，即结果为0时，不跳转
>  
>     t4：1->End
>
> - 双字长，直接寻址的分支指令JMP（即转移目标地址A在指令第2字中）
>
>   t1~t3：取指令序列(略)
>
>   t4：PC->MAR，1->Read #用PC为地址读取A
>
>   t5：(PC)+1，M[(MAR)]->MDR
>
>   t6：MDR->PC，1->End

## CPU中的数据通路

### 结构

根据不同部件是否共享信号线，数据通路结构分为以下两类：

- 总线结构

  总线结构是一组并行的导线，用于连接多个组件，但一次只有一个组件可以使用它。

  优缺点：部件互联简单，但是数据传输较慢

  ![image-20230909172931710](https://gitee.com/Marches7/piture-bed/raw/master/img/image-20230909172931710.png)

- 点点结构

  每一对组件之间都有一个独立的连接。这意味着每个连接只被这两个组件使用，没有其他组件共享这个连接。

  优缺点：部件互联复杂，但是数据传输较快

  ![image-20230909173010998](https://gitee.com/Marches7/piture-bed/raw/master/img/image-20230909173010998.png)

## CPU中的控制器

控制器的时序系统描述了μOP控制信号的产生方法，根据时序系统的不同，控制器可以分为硬布线控制器和微程序控制器两类。

二者区别：

1. 实现方式：硬布线是基于组合逻辑的直接电路实现，而微程序控制器是基于微指令序列的。
2. 灵活性：微程序控制器在修改和扩展方面更为灵活。
3. 速度：硬布线控制器通常比微程序控制器更快。
4. 复杂性：对于复杂的指令集，使用微程序控制器可能更为简洁和组织良好。
5. 修改和维护：微程序控制器更易于修改和维护。

### 硬布线控制器

RISC计算机全部采用硬布线控制器

#### 组成

<img src="https://gitee.com/Marches7/piture-bed/raw/master/img/image-20230911170426270.png" alt="image-20230911170426270" style="zoom:67%;float:left" />

#### 硬布线时序系统

- 时序信号

  为了确保所有操作都能在正确的时间内进行，我们需要一些基本的时序信号来同步整个时序系统。时序信号可分为以下三级：

  - 机器周期

    机器周期是执行一次完整操作所需的时间，例如读取内存或执行算术操作。

    > 在早期的计算机中，执行一个指令可能只需要一个机器周期。但在现代复杂的微处理器中，一个指令可能需要多个机器周期，或者在一个机器周期内可能执行多条指令（例如在超标量处理器中）

  - 节拍

    一个机器周期可以分为多个节拍，每个节拍执行一个完整操作的μOP。

  - 工作脉冲

    每个节拍可以分为若干个工作脉冲（具体个数与节拍无关，只与节拍要完成的μOP有关），用于指导或控制特定的操作，并且确保操作在一个节拍内的正确时间开始和结束。

- 组成

  - 早期计算机的三级时序系统

    共有10个时序信号(CP)，每个指令周期最多包含4个机器周期(M0~M3)，每个机器周期包含3个节拍(T0~T2)，每个节拍包含3个工作脉冲(P0~P2)

    ![image-20230911115947477](https://gitee.com/Marches7/piture-bed/raw/master/img/image-20230911115947477.png)

  - 现代计算机的二级时序系统

    为了减少延迟和成本，现代计算机的时序系统由节拍(T0~T4)和工作脉冲(P0~P1)两级时序组成

    ![image-20230911120150926](https://gitee.com/Marches7/piture-bed/raw/master/img/image-20230911120150926.png)

  - 时序信号形成电路的组成

    由环形信号发生器和定时逻辑组成

- 控制方式

  - 同步控制

    所有的操作都在时钟的驱动下进行。

    优点：结构简单，操作可靠。

    缺点：不同操作的时延不同，会有较大的时间浪费

  - 异步控制

    异步控制不依赖于时钟，而是依赖于各种操作的完成情况。

    优点：速度较快，因为不受时钟频率的限制，每个操作可以在完成后立即触发下一个操作。

    缺点：设计复杂，可能会出现操作冲突

  - 联合控制

    联合控制是同步控制和异步控制的结合。基本操作是在时钟的同步下进行，但某些可以并行的操作可以在完成后立即触发其他操作，而不必等待下一个时钟周期。

    几乎所有CPU都采用联合控制方式

### 微程序控制器

CISC计算机全部采用了微程序控制器。

#### 组成

![image-20230911162850997](https://gitee.com/Marches7/piture-bed/raw/master/img/image-20230911162850997.png)

#### 微指令

- 指令字段

  微指令由**操作控制字段**和**顺序控制字段**组成，与指令格式类似，操作控制字段指明当前微指令所要执行的操作，顺序控制字段指明下条微指令地址的形成方法。

  - 操作控制字段

    编码方式有以下三种：

    - 直接编码方式

      操作控制字段每一位定义一个微指令，操作控制字段长度等于微命令总个数。

      <img src="https://gitee.com/Marches7/piture-bed/raw/master/img/image-20230911154750136.png" alt="image-20230911154750136" style="zoom:80%;float:left" />

    - 字段直接编码方式

      把操作控制字段分成多个子字段，每个子字段假如有k位，则每个字段可以定义2^k-1个微命令，减去的1代表对应子字段的所有微命令全部无效。

      <img src="https://gitee.com/Marches7/piture-bed/raw/master/img/image-20230911154817418.png" alt="image-20230911154817418" style="zoom:80%;float:left" />

    - 字段间接编码方式

      操作控制字段由多个子字段构成，部分子字段需要与其他子字段的编码联合起来定义一个命令。

      <img src="https://gitee.com/Marches7/piture-bed/raw/master/img/image-20230911155017620.png" alt="image-20230911155017620" style="zoom:80%;float:left" />

  - 顺序控制字段

    微地址形成方法有以下几种：

    - 计数器法

      适用于顺序型微指令，下条指令地址等于当前指令地址+1

    - 下址法

      适用于顺序型、跳转型微指令，即下条指令地址由顺序控制字段直接给出

    - 测试网络法

      适用于多路分支型微指令，基于某些条件觉得跳转到哪个地址。例如检查零标志位，根据标志位选择下条指令地址。

    - 硬件产生法

      由专门的硬件电路产生固定的微指令地址，如中断响应微程序入口等地址。

    从实际来说，顺序控制字段的组织有增量法和断定法两类。

    增量法：由计数器法和测试网络法组合而成

    断定法：由下址法和测试网络法组合而成

- 指令格式

  微指令都采用定长指令字格式，可以分为水平型和垂直型两种格式

  - 水平型

    重视并行控制功能，一条微指令可以执行多个微命令，微指令字段较长。

    由于微程序中的微指令数量不多，为了提高CPU性能，大都采用水平型微指令格式。

    **特点**：**强调并行控制**，执行μOP能力强，**效率高**，**机器指令的执行速度快**，微程序的代码效率低，**更多的体现控制器的硬件特点**。

  - 垂直型
  
    不强调并行控制功能，因此大多一条指令只执行一个微命令，也可以执行多个微命令。微指令字段较短。


## CPU异常及中断

### 异常

也称为内中断、软中断，**异常**通常是由于程序指令执行过程中出现的错误导致的。例如，除数为零、访问非法内存地址、指令错误等。

**异常**是同步的，意味着它由指令执行引起，发生在指令周期内

异常不可被屏蔽。

根据异常的报告及返回方式，异常可分为：

- 故障(Fault)

  故障是一种可能被修复的异常，例如缺页，除零等，处理结束后返回当前指令重新执行。

- 陷阱(Trap)

  陷阱是一种预先安排的异常，例如权限切换，系统调用。

- 终止(Abort)

  终止是一种不可修复的异常，如硬件故障，无效系统表项。

### 中断

也称为外中断、硬中断，**中断**是外部事件触发的，如I/O操作完成、定时器时间到、外部设备的信号等。这些事件可能与当前执行的程序无关。

**中断**是异步的，意味着它可以在任何时间发生，与CPU当前执行的指令无关。

可分为可屏蔽中断和不可屏蔽中断。

### 处理过程

![image-20230912114308503](https://gitee.com/Marches7/piture-bed/raw/master/img/image-20230912114308503.png)

1. 响应

   异常及中断的响应指CPU从当前程序转到处理程序的过程。响应需要完成：

   - 保存断点及程序状态

   - 关中断

   - 识别事件类型并转入处理程序

     - 非向量方式

       所有异常及中断共用一个处理程序，又称为软件识别方式

     - 向量方式

       指每个异常及中断都有一个处理程序，又称为硬件识别方式

2. 处理

3. 返回

## 指令流水线

### 工作过程

![image-20230912114625609](https://gitee.com/Marches7/piture-bed/raw/master/img/image-20230912114625609.png)

> 纵坐标“段”的含义：IF(取指)，ID(译码)，OF(取操作数)，EX(执行)，写结果(WB)。每个段可以完成一个μOP。
>
> 横坐标每一拍通常为一个时钟周期，每一拍都可以流入流出一条指令，**相当于**CPI(单个指令所需的时钟周期数)=1.

### 冒险处理

流水线在某些情况下会无法正确执行后续指令，这种现象称为冒险(Hazard)

- 结构冒险

  指由于争用硬件资源而引起的冒险。

  例如不同指令的IF段和MEM段会争用存储器。

- 数据冒险

  当某条指令的结果尚未写入，后续指令就需要读取，这样的冒险称为写后读(RAW，Read After Write)冒险，是数据冒险的一种，本书只讨论数据冒险中的RAW冒险。

  ![image-20230912122307920](https://gitee.com/Marches7/piture-bed/raw/master/img/image-20230912122307920.png)

  - 解决策略

    - 阻塞法

      采用插入气泡的方法来实现，又称为后推法。思想是使冲突指令及其后续指令停顿，原本该有指令的地方变成气泡(nop指令)，正常指令后推。

      ![image-20231123142146536](https://gitee.com/Marches7/piture-bed/raw/master/img/image-20231123142146536.png)

    - 转发法

      又称为重定向法和旁路法，可以将结果送到之前的段中。

      如图I1的EX段结果、MEM段结果都等于WB段所写的数据，故I2，I3段可以分别直接从I1的EX段和MEM段获取数据，I4段获取的方法使寄存器提前写，即寄存器写操作安排在前半拍，后半拍就能直接读出正确结果。

      ![image-20230912125151016](https://gitee.com/Marches7/piture-bed/raw/master/img/image-20230912125151016.png)

    - 乱序执行法

      思想是只停顿冲突指令，后续无RAW冒险的指令可以先执行。是阻塞法的变种，又称为动态调度法。
      
      <img src="https://gitee.com/Marches7/piture-bed/raw/master/img/image-20231126221927132.png" alt="image-20231126221927132" style="zoom:50%;" />

- 控制冒险

  指令执行顺序发生变化，而引起流水线停顿的现象。转移型指令会改变指令执行顺序，之后流入的指令可能是错误的。

  如图，指令I2在第5拍才判断是否转移和写PC，这时指令I3早已进入流水线，而I2的下一条指令可能不是I3，导致程序执行错误。

  ![image-20230912155911248](https://gitee.com/Marches7/piture-bed/raw/master/img/image-20230912155911248.png)

  - 解决策略

    - 阻塞法

      阻塞分支指令之后的指令，直到控制冒险消除。用过插入气泡来实现。

    - 分支预测法

      预测分支指令的转移方向，并执行该方向指令，预测正确继续执行，预测错误则回头重新执行。

      - 静态预测：总是预测不转移
      - 动态预测：根据分支指令的转移历史预测，正确率可高达90%

    - 延迟分支法
    
      分支指令结束前，跟随分支指令流入流水线的指令位置称为延迟槽。延迟槽可以包含有用的指令，相当于减少了流水线停顿时间。
    
      <img src="https://gitee.com/Marches7/piture-bed/raw/master/img/image-20231126222146067.png" alt="image-20231126222146067" style="zoom:67%;" />

### 性能指标

- 吞吐率

  指单位时间内流水线完成的工作量

  若指令流水线有m个段，拍长为▲t，连续执行n条指令，则该流水线的吞吐量为：
  $$
  T_p=\frac{n}{T_{流水}}=\frac{n}{m\Delta t+(n-1)\Delta t}=\frac{1}{(\frac{m-1}{n}+1)\Delta t}
  \\当n>>m时,T_{pmax}=\frac{1}{\Delta  t},即最大吞吐量为拍长的倒数
  $$
  
- 加速比

  加速比指程序采用流水方式执行与采用串行方式执行的速度比。

  若指令流水线有m个段，拍长为▲t，连续执行n条指令，则该流水线的加速比为
  $$
  S=\frac{T_{串行}}{T_{流水}}=\frac{m\Delta t\times n}{m\Delta t+(n-1)\Delta t}=\frac{mn}{m+(n-1)}=\frac{m}{\frac{m}{n}+(1-\frac{1}{n})}
  \\当n>>m>>1时，S=m,即最大加速比等于流水线段数
  $$
  
- 效率

  即部件利用率，指流水线中单个部件的平均使用时间与整个运行时间的比值。

  若指令流水线有m个段，拍长为▲t，连续执行n条指令，则该流水线的效率为
  $$
  E=\frac{\frac{\sum_{i=1}^mT{段i}}{m}}{T流水}=\frac{\frac{n\Delta t\times m}{m}}{m\Delta t+(n-1)\Delta t}=\frac{n}{m+n-1}=\frac{1}{\frac{m}{n}+1-\frac{1}{n}}
  \\当n>>m时，最高效率为E_{max}=1,即连续执行的指令越多，流水线效率越高
  $$

### 高性能流水线

- 超标量流水线

  也称动态发射技术，并行流入多条指令(多条指令并行工作)

  ![image-20230912163243057](https://gitee.com/Marches7/piture-bed/raw/master/img/image-20230912163243057.png)

## 多核处理器的基本概念

## 提高部分

- 什么是时钟周期，机器周期和指令周期？

  时钟周期是最基础的时间单位，又称为节拍周期。描述了CPU时钟的一个脉冲。一个时钟周期内，CPU可以完成一些基本操作，如数据传送、算术逻辑操作等。一个μOP通常在一个时钟周期完成。

  机器周期是由多个时钟周期组成，又称为CPU周期。一个机器周期例如取指令周期，执行指令周期，DMA指令周期等

  指令周期是由一个或多个机器周期组成。CPU一条指令在一个指令周期中完成称为单周期CPU，一条指令在多个指令周期中完成称为多周期CPU。

  <img src="https://gitee.com/Marches7/piture-bed/raw/master/img/image-20231122213829137.png" alt="image-20231122213829137" style="zoom: 67%;" />

  <img src="https://gitee.com/Marches7/piture-bed/raw/master/img/image-20231122214142778.png" alt="image-20231122214142778" style="zoom: 67%;" />

- 指令周期和数据通路结构

  |          | 单周期CPU                        | 多周期CPU                                                    |
  | -------- | -------------------------------- | ------------------------------------------------------------ |
  | 指令周期 | 一个时钟周期组成                 | 多个时钟周期组成                                             |
  | 数据通路 | 只能采用点点结构                 | 可采用总线结构或点点结构                                     |
  | 部件使用 | 不可重复使用                     | 可以随意使用                                                 |
  | 存储器   | 必须采用哈佛结构                 | 哈佛或冯诺依曼结构                                           |
  | 优劣     | 性能差，成本高，但是结构控制简单 | 1.总线结构下，控制简单，性能较差 2.点点结构下，控制复杂，性能较好 |

  

