---
title: 总线
date: 2023-07-29 11:14 
categories:
- 计算机基础
tags:
---
<head>
  <meta name="referrer" content="no-referrer" />
</head>



## 分类

总线是计算机部件之间的一种互连通道。

- 按功能分类
  - 数据总线：承载数据内容传输的功能，是双向传输线
  - 地址总线：承载数据地址传输的功能，是单向传输线，只有主设备才会发出地址信息
  - 控制总线：又分为控制线和状态线，主设备通过控制线控制从设备，从设备通过状态线告知状态。是单向传输线
- 按连接部件分类
  - 片内总线：CPU内部的总线，如CPU的数据通路
  - 系统总线：连接主存，外设，CPU的总线，这些部件都安放在主板上，故又称为板级总线。由于不同部件相差速度较大，系统总线还可分为：
    - HOST总线：连接CPU，主存等快速部件，如PCI总线
    - I/O总线：连接各种中速或慢速外备，如ISA总线
  - 通信总线：计算机之间的总线，例如光纤等

## 性能指标

- 总线宽度：即总线最多能传送的二进制位数

- 总线带宽：总线带宽指总线最大数据传输率，即单位时间最多可传送数据位数，单位为Mb/s或Mbps或MB/s或MBps
  $$
  总线带宽B=总线宽度\times数据传输次数/秒
  \\=总线宽度\times工作频率
  \\=总线宽度\times \frac{总线每秒经历的时钟数(又称为:总线时钟频率)}{一次数据传输所需的时钟数}
  $$

## 工作过程

1. 申请及分配阶段

   需要使用总线的主设备向总线仲裁器提出请求，总线仲裁器依据相关策略决定下个使用者。

2. 寻址阶段

   获得使用权的主设备通过总线发出地址和命令，选择和启动从设备。

3. 传送数据阶段

   主设备和从设备进行数据交换

4. 结束阶段

   主设备和从设备从总线上撤销信号，让出总线使用权

> (1)阶段1.被称为总线申请周期，阶段2.3.4.被称为总线传输周期
>
> (2)寻址阶段又称为地址期，传送数据阶段和结束阶段又称为数据期
>
> (3)下一个设备的申请及分配阶段可以安排当前设备的结束阶段进行，这种总线仲裁方式称为隐藏式仲裁，否则称为显式仲裁，隐藏式仲裁可以提高效率，即总线周期与总线传输周期相等

## 总线仲裁

总线仲裁即决定下一个使用设备的过程。根据仲裁器的位置不同，可以分为集中式和分布式仲裁

- 集中式仲裁

  有一个单独的总线仲裁器。每个主设备与总线仲裁器的信号线有：总线请求线BR，总线允许线BG，总线忙线BS。集中式仲裁常见有三种仲裁策略：

  - 链式查询方式(菊花链)

    仲裁时从头轮询各个主设备。

    ![image-20230918123018807](https://gitee.com/Marches7/piture-bed/raw/master/img/image-20230918123018807.png)
    $$
    \begin{flalign*}
    &if(BR·\overline{BS}=1)\{
    \\&\quad\quad开始仲裁;
    \\&\quad\quad BG=1;
    \\&\quad\quad if(BR_i·BG_{iIN}=1)\{
    \\&\quad\quad\quad\quad BS=1;
    \\&\quad\quad\quad\quad BG_{iOUT}=0;
    \\&\quad\quad\quad\quad 结束仲裁;
    \\&\quad\quad\}
    \\&\quad\quad else\{
    \\&\quad\quad\quad\quad BS=0;
    \\&\quad\quad\quad\quad BG_{iOUT}=BG_{iIN}=1;
    \\&\quad\quad\quad\quad BG_{(i+1)IN}=BG_{iOUT}
    \\&\quad\quad\}
    \\\}
    \end{flalign*}
    $$

    > (1)可以得到BGiout=BRi反×BGiIN，实现自动轮询
    >
    > (2)是固定式优先级，与总线仲裁器越近，优先级越高
    >
    > (3)优点是线路简单，缺点是不公平，且容易导致断链
    >
    > (4)控制线总数：1(BS)+1(BR)+1(BG)=3

  - 计数器定时查询方式

    用⌈log2n⌉根设备号总线代替菊花链，避免断链。n为设备总数。也采用轮询方式不同的是由自动轮询改为逐次、定时轮询。

    ![image-20230918124449522](https://gitee.com/Marches7/piture-bed/raw/master/img/image-20230918124449522.png)
    $$
    \begin{flalign*}
    \\&DevID_i:主设备i的设备号
    \\&仲裁器访问的设备号:DevNow
    \\&定时时间:\Delta t
    \\&if(BR·\overline{BS}=1)\{
    \\&\quad\quad开始仲裁;
    \\&\quad\quad DevNow=i;
    \\&\quad\quad if(BR_i·(DevID_i==DevNow))\{
    \\&\quad\quad\quad\quad BS=1;
    \\&\quad\quad\quad\quad 结束仲裁;
    \\&\quad\quad\}
    \\&\quad\quad elseif(DevNow=i的信号保持时间\geq\Delta t)\{
    \\&\quad\quad\quad\quad BS=0;
    \\&\quad\quad\quad\quad DevNow=i+1;
    \\&\quad\quad\}
    \\\}
    \end{flalign*}
    $$

    > (1)这种仲裁方式是固定优先级或者循环优先级，由DevNow=0或者k+1决定
    >
    > (2)优点是保证公平性，对电路稳定性较好，缺点是仲裁线较多。
    >
    > (3)控制线总数：1(BS)+1(BR)+⌈log2n⌉(BG)=2+⌈log2n⌉

  - 独立请求方式

    每个设备分别与总线仲裁器单独连接。无需依次询问主设备，仲裁器根据算法运算结果直接选择主设备。**仲裁过程不需要主设备参与。**

    ![image-20230918125812605](https://gitee.com/Marches7/piture-bed/raw/master/img/image-20230918125812605.png)
    $$
    \begin{flalign*}
    &if(\sum BR_i=1)\{
    \\&\quad\quad开始仲裁;
    \\&\quad\quad 根据内部电路决定BG_i=1;
    \\&\quad\quad仲裁结束;
    \\\}
    \end{flalign*}
    $$

    > (1)可以实现固定优先级，动态优先级等多种算法策略
    >
    > (2)仲裁时延是固定的，可以实现隐藏式仲裁，其他2种方式无法实现
    >
    > (3)优点是仲裁快，公平，可以实现隐藏式仲裁，因此现代计算机都采用独立请求的方式
    >
    > (4)控制线总数：1(BS)+n(BR)+n(BG)=1+2n

- 分布式仲裁

  总线仲裁器分布在每个设备中。仲裁策略常见的有以下2种

  - 自举式

    每个仲裁器只连接更高优先级的总线请求线，有请求的主设备检测所连接的其他设备的信号线，若自身优先级最高(其他设备无请求)时获得总线使用权。

    ![image-20230918130851887](https://gitee.com/Marches7/piture-bed/raw/master/img/image-20230918130851887.png)

    > 假设从主设备0到主设备n-1，优先级依次递增。

  - 竞争式

    各个设备根据其优先级产生一个优先权码(仲裁号)，然后这些优先权码从高位开始并行地进行比较，确定出优先权最高的模块，从而获得总线使用权。

## 总线定时

- 同步定时方式

  总线事务由统一的时钟信号控制。

- 异步定时

  总线事务的定时通过异步传输协议"握手"来实现。异步传输协议又称为应答协议或握手协议，包括请求，响应，撤销请求，撤销响应4个阶段。根据握手次数，异步定时的应答方式又可分为：

  - 全互锁

    <img src="https://gitee.com/Marches7/piture-bed/raw/master/img/image-20230918162404189.png" alt="image-20230918162404189" style="zoom:67%;float:left" />

    全互锁是主/从设备发送信号后，需等对方撤销信号才能撤销自己的。每次响应有两次互锁。

  - 半互锁

    <img src="https://gitee.com/Marches7/piture-bed/raw/master/img/image-20230918162442534.png" alt="image-20230918162442534" style="zoom:67%;float:left" />

    半互锁下，主设备发信号后需等从设备响应才撤销；从设备则按约定时间自行撤销。每次响应涉及一次互锁。

  - 不互锁

    <img src="https://gitee.com/Marches7/piture-bed/raw/master/img/image-20230918162504949.png" alt="image-20230918162504949" style="zoom:67%;float:left" />

    不互锁下，主/从设备发信号后，不等对方，按约定时间自行撤销。每次响应不涉及互锁。

- 半同步定时方式

  总线事务的定时由时钟信号，应答信号共同完成，

## 总线传输模式

总线的传输模式描述了数据在总线上如何流动和进行交互。

## 总线标准

指总线应遵守的一些协议和规范。